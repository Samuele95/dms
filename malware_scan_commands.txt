# Malware Scan Commands Reference
# Tsurugi Linux DFIR
# ==========================================

# ==========================================
# 1. DRIVE IDENTIFICATION & MOUNTING
# ==========================================

# List all block devices
lsblk -o NAME,SIZE,TYPE,MOUNTPOINT,FSTYPE

# Mount drive (user-level, no sudo)
udisksctl mount -b /dev/sda1

# Check mount and usage
df -h /media/tsurugi/<mount-point>
mount | grep sda1

# Unmount when done
udisksctl unmount -b /dev/sda1

# ==========================================
# 2. TOOL VERIFICATION
# ==========================================

# Check available basic scanning tools
which clamscan yara strings binwalk

# Check available deep scan tools
which foremost photorec scalpel bulk_extractor ssdeep md5deep exiftool

# List installed security packages
dpkg -l | grep -E "clamav|yara|chkrootkit|rkhunter|foremost|ssdeep"

# ==========================================
# 3. CLAMAV DATABASE UPDATE
# ==========================================

# Update to temp directory (avoids permission issues)
mkdir -p /tmp/clamdb
freshclam --datadir=/tmp/clamdb --log=/tmp/freshclam.log

# Check database status
ls -la /tmp/clamdb/

# ==========================================
# 4. CLAMAV SCANNING
# ==========================================

# Scan mounted filesystem
clamscan --database=/tmp/clamdb -r /media/tsurugi/<mount-point>

# Scan raw disk in chunks (for block devices)
dd if=/dev/sda1 bs=1M count=500 skip=0 | clamscan --database=/tmp/clamdb -
dd if=/dev/sda1 bs=1M count=500 skip=500 | clamscan --database=/tmp/clamdb -
dd if=/dev/sda1 bs=1M count=500 skip=1000 | clamscan --database=/tmp/clamdb -
# Continue with appropriate skip values...

# Full disk scan (single command, memory intensive)
dd if=/dev/sda1 bs=1M | clamscan --database=/tmp/clamdb -

# ==========================================
# 5. YARA SCANNING
# ==========================================

# Find YARA rules on system
find /opt -name "*.yar" -o -name "*.yara" 2>/dev/null

# Tsurugi YARA rule locations:
# /opt/Qu1cksc0pe/Systems/Windows/YaraRules_Windows/
# /opt/Qu1cksc0pe/Systems/Linux/YaraRules_Linux/
# /opt/Qu1cksc0pe/Systems/Android/YaraRules/
# /opt/oledump/

# Scan with single rule file
yara -w /path/to/rule.yara /dev/sda1

# Scan raw disk with YARA (piped)
dd if=/dev/sda1 bs=1M count=500 | yara -w /path/to/rule.yara -

# Batch scan with multiple rules
for rule in /opt/Qu1cksc0pe/Systems/Windows/YaraRules_Windows/*.yara; do
    result=$(dd if=/dev/sda1 bs=1M count=500 2>/dev/null | yara -w "$rule" - 2>/dev/null)
    [ -n "$result" ] && echo "=== $rule ===" && echo "$result"
done

# ==========================================
# 6. BINWALK SIGNATURE ANALYSIS
# ==========================================

# Scan for embedded file signatures
binwalk --signature /dev/sda1

# Extract embedded files (creates output directory)
binwalk --extract /dev/sda1 -C /tmp/binwalk_output

# ==========================================
# 7. STRING ANALYSIS
# ==========================================

# Extract all strings (min 8 chars)
strings -n 8 /dev/sda1 > /tmp/strings_output.txt

# Search for URLs
strings /dev/sda1 | grep -iE "http://|https://"

# Search for executables
strings /dev/sda1 | grep -iE "\.exe|\.dll|\.bat|\.ps1|\.vbs"

# Search for credentials
strings /dev/sda1 | grep -iE "password|passwd|credential|admin|root"

# Search for ransomware indicators
strings /dev/sda1 | grep -iE "ransomware|decrypt|bitcoin|wallet|encrypt"

# Search for malware indicators
strings /dev/sda1 | grep -iE "malware|trojan|keylog|backdoor"

# Search for shell commands
strings /dev/sda1 | grep -iE "cmd\.exe|powershell|wscript|cscript"

# Combined suspicious pattern search
dd if=/dev/sda1 bs=1M | strings -n 10 | grep -iE "(http://|https://|\.exe|\.dll|password|ransomware|bitcoin|keylog)"


# ==========================================
# 8. DEEP SCAN - FILE CARVING
# ==========================================

# Recover deleted files with foremost
mkdir -p /tmp/carved
foremost -t all -i /dev/sda1 -o /tmp/carved

# Check foremost results
cat /tmp/carved/audit.txt
find /tmp/carved -type f ! -name "audit.txt" -exec file {} \;

# Recover with photorec (interactive)
photorec /dev/sda1

# Recover with scalpel (configure /etc/scalpel/scalpel.conf first)
scalpel -c /etc/scalpel/scalpel.conf -o /tmp/scalpel_output /dev/sda1

# Scan recovered files for malware
clamscan --database=/tmp/clamdb -r /tmp/carved

# ==========================================
# 9. DEEP SCAN - ENTROPY ANALYSIS
# ==========================================

# Python entropy analysis script
python3 << 'EOF'
import subprocess
import math

chunk_size_mb = 50
num_chunks = 20
device = "/dev/sda1"

for i in range(num_chunks):
    offset = i * chunk_size_mb
    cmd = f"dd if={device} bs=1M count={chunk_size_mb} skip={offset} 2>/dev/null"
    result = subprocess.run(cmd, shell=True, capture_output=True)
    data = result.stdout

    if len(data) == 0:
        continue

    freq = [0]*256
    for b in data:
        freq[b] += 1

    entropy = 0
    for f in freq:
        if f > 0:
            p = f / len(data)
            entropy -= p * math.log2(p)

    status = "HIGH ENTROPY - SUSPICIOUS" if entropy > 7.5 else "Normal"
    print(f"Region {offset}MB: Entropy={entropy:.2f}/8.0 - {status}")
EOF

# ==========================================
# 10. DEEP SCAN - BULK EXTRACTOR
# ==========================================

# Run bulk_extractor for comprehensive artifact extraction
mkdir -p /tmp/bulk_output
bulk_extractor -o /tmp/bulk_output /dev/sda1

# Check bulk_extractor results
ls -la /tmp/bulk_output/
cat /tmp/bulk_output/email.txt      # Extracted emails
cat /tmp/bulk_output/url.txt        # Extracted URLs
cat /tmp/bulk_output/ccn.txt        # Credit card numbers
cat /tmp/bulk_output/winpe.txt      # Windows PE artifacts
cat /tmp/bulk_output/json.txt       # JSON fragments

# ==========================================
# 11. DEEP SCAN - EXECUTABLE DETECTION
# ==========================================

# Search for PE (Windows) executables
dd if=/dev/sda1 bs=1M | grep -boa "MZ" | head -20

# Search for ELF (Linux) executables
dd if=/dev/sda1 bs=1M | grep -boa $'\x7fELF' | head -20

# ==========================================
# 12. DEEP SCAN - BOOT SECTOR ANALYSIS
# ==========================================

# Extract boot sector
dd if=/dev/sda1 of=/tmp/boot_sector.bin bs=512 count=1

# Analyze boot sector
xxd /tmp/boot_sector.bin | head -50
file /tmp/boot_sector.bin

# Check MBR signature (should end with 55AA)
xxd -p /tmp/boot_sector.bin | tail -c 5

# Check for PE header in boot sector (bootkit indicator)
xxd -p /tmp/boot_sector.bin | grep -i "4d5a"

# ==========================================
# 13. DEEP SCAN - HASH ANALYSIS
# ==========================================

# Generate MD5 hashes for all files
md5deep -r /media/tsurugi/<mount-point> > /tmp/file_hashes_md5.txt

# Generate SHA256 hashes
sha256deep -r /media/tsurugi/<mount-point> > /tmp/file_hashes_sha256.txt

# Generate fuzzy hashes (ssdeep)
ssdeep -r /media/tsurugi/<mount-point> > /tmp/fuzzy_hashes.txt

# Compare hashes against known malware (example with VirusTotal - requires API key)
# vt file <hash> --apikey <your-api-key>

# ==========================================
# 14. DEEP SCAN - METADATA EXTRACTION
# ==========================================

# Extract metadata from files
exiftool -r /media/tsurugi/<mount-point> > /tmp/metadata.txt

# Extract metadata from specific file types
find /media/tsurugi/<mount-point> -name "*.pdf" -exec exiftool {} \;
find /media/tsurugi/<mount-point> -name "*.doc*" -exec exiftool {} \;

# ==========================================
# 15. ADDITIONAL FORENSIC TOOLS
# ==========================================

# List files including deleted (Sleuth Kit) - requires root
fls /dev/sda1

# Create timeline of file activity
fls -r -m "/" /dev/sda1 > /tmp/bodyfile.txt
mactime -b /tmp/bodyfile.txt > /tmp/timeline.txt

# Check for rootkits (on mounted system)
chkrootkit -r /media/tsurugi/<mount-point>
rkhunter --check --sk

# Hex dump analysis
xxd /dev/sda1 | head -1000 > /tmp/hexdump.txt

# ==========================================
# 16. QUICK ONE-LINER SCANS
# ==========================================

# Quick ClamAV scan of raw disk
dd if=/dev/sda1 bs=1M | clamscan --database=/tmp/clamdb -v -

# Quick YARA scan all Windows rules
for r in /opt/Qu1cksc0pe/Systems/Windows/YaraRules_Windows/*.yara; do dd if=/dev/sda1 bs=1M count=100 2>/dev/null | yara -w "$r" - 2>/dev/null; done

# Quick suspicious strings check
dd if=/dev/sda1 bs=1M count=500 | strings -n 10 | grep -iE "(password|bitcoin|ransomware|\.exe)" | head -50

# Quick entropy check (first 100MB)
dd if=/dev/sda1 bs=1M count=100 2>/dev/null | python3 -c "import sys,math;d=sys.stdin.buffer.read();f=[0]*256
for b in d:f[b]+=1
e=sum(-p/len(d)*math.log2(p/len(d)) for p in f if p>0);print(f'Entropy: {e:.2f}/8.0')"

# ==========================================
# 17. AUTOMATED SCRIPT USAGE
# ==========================================

# Basic scan
./malware_scan.sh /dev/sda1

# Mount and scan
./malware_scan.sh /dev/sda1 -m

# Update databases and scan
./malware_scan.sh /dev/sda1 -u

# Deep forensic scan
./malware_scan.sh /dev/sda1 -d

# Full scan with all options
./malware_scan.sh /dev/sda1 -m -u -d -o my_report.txt
